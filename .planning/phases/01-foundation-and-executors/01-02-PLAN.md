---
phase: 01-foundation-and-executors
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/executor/claude.go
  - internal/executor/claude_test.go
  - internal/executor/npm.go
  - internal/executor/npm_test.go
  - internal/executor/find.go
autonomous: true

must_haves:
  truths:
    - "ClaudeExecutor streams stdout/stderr via bytes.Buffer (no cmd.Output deadlocks)"
    - "ClaudeExecutor passes prompts via stdin (no shell argument limits)"
    - "NPMExecutor finds npm/npx across nvm, volta, asdf, fnm, and standard PATH"
    - "Both executors return descriptive errors when binaries not found"
  artifacts:
    - path: "internal/executor/claude.go"
      provides: "ClaudeExecutor interface and implementation"
      exports: ["ClaudeExecutor", "NewClaudeExecutor", "WithModel", "WithOutputFormat"]
      min_lines: 50
    - path: "internal/executor/npm.go"
      provides: "NPMExecutor interface and implementation"
      exports: ["NPMExecutor", "NewNPMExecutor"]
      min_lines: 40
    - path: "internal/executor/find.go"
      provides: "Node executable finder with version manager fallbacks"
      exports: ["FindNodeExecutable"]
      min_lines: 25
  key_links:
    - from: "internal/executor/claude.go"
      to: "os/exec"
      via: "exec.CommandContext with bytes.Buffer"
      pattern: "cmd\\.Stdout = &stdout"
    - from: "internal/executor/find.go"
      to: "os/exec"
      via: "exec.LookPath with fallback candidates"
      pattern: "exec\\.LookPath"
---

<objective>
Implement ClaudeExecutor and NPMExecutor with TDD to ensure correct subprocess patterns.

Purpose: These executors are the backbone of all AI and npm operations. Getting subprocess handling right (streaming, stdin piping, PATH resolution) prevents the most common and hardest-to-debug failures.
Output: Tested executor interfaces that safely invoke claude and npm/npx subprocesses.
</objective>

<execution_context>
@/Users/rich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-executors/01-RESEARCH.md
</context>

<feature>
  <name>Subprocess Executors (ClaudeExecutor + NPMExecutor)</name>
  <files>
    internal/executor/claude.go, internal/executor/claude_test.go,
    internal/executor/npm.go, internal/executor/npm_test.go,
    internal/executor/find.go
  </files>
  <behavior>
    ClaudeExecutor:
    - Execute(ctx, prompt) -> (string, error): runs `claude -p --output-format text` with prompt on stdin, returns stdout
    - Execute(ctx, prompt, WithModel("sonnet")) -> adds `-m sonnet` flag
    - Returns stderr content in error when process fails
    - Uses bytes.Buffer for stdout/stderr (NOT cmd.Output())
    - Uses cmd.Start() + cmd.Wait() pattern (NOT cmd.Run() with Output)
    - Respects context cancellation

    NPMExecutor:
    - Install(ctx, dir, packages...) -> error: runs `npm install <packages>` in dir
    - CheckInstalled(ctx, dir, pkg) -> (bool, error): checks node_modules/<pkg> exists
    - Init(ctx, dir) -> error: runs `npm init -y` in dir

    FindNodeExecutable:
    - FindNodeExecutable(name) -> (string, error): tries exec.LookPath, then fallback locations
    - Fallback locations: ~/.nvm/current/bin, ~/.volta/bin, ~/.asdf/shims, ~/.fnm/current/bin, /usr/local/bin, /opt/homebrew/bin
    - Returns descriptive error with install instructions when not found

    Test approach: Use mock/fake binaries for subprocess tests. For ClaudeExecutor, create a small test helper script that echoes stdin or returns known output. For FindNodeExecutable, test with temp directories. For NPMExecutor, test CheckInstalled with temp node_modules directories.
  </behavior>
  <implementation>
    Follow research patterns exactly (Pattern 1: streaming, Pattern 2: stdin piping, Pattern 3: PATH resolution).

    ClaudeExecutor implementation:
    - Interface with Execute method
    - Functional options (WithModel, WithOutputFormat)
    - cmd.Stdin = strings.NewReader(prompt)
    - var stdout, stderr bytes.Buffer; cmd.Stdout = &stdout; cmd.Stderr = &stderr
    - cmd.Start() then cmd.Wait()
    - Include stderr in error message on failure

    NPMExecutor implementation:
    - Interface with Install, CheckInstalled, Init methods
    - Uses findNodeExecutable to resolve npm/npx paths at construction time
    - cmd.Dir = dir for all commands
    - Captures stderr for error messages

    FindNodeExecutable:
    - Separate file for reuse
    - exec.LookPath first, then iterate candidate paths
    - os.Stat to check existence
  </implementation>
</feature>

<verification>
1. `go test ./internal/executor/ -v` - all tests pass
2. `go build ./...` - compiles
3. ClaudeExecutor test proves bytes.Buffer pattern (not cmd.Output)
4. FindNodeExecutable test proves fallback search works
</verification>

<success_criteria>
- ClaudeExecutor streams subprocess output via bytes.Buffer with stdin piping
- NPMExecutor resolves npm/npx paths with version manager fallbacks
- All executor tests pass
- No use of cmd.Output() anywhere in executor code
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-executors/01-02-SUMMARY.md`
</output>
