---
phase: 01-foundation-and-executors
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - cmd/root.go
  - cmd/version.go
  - main.go
  - internal/preflight/checks.go
  - internal/preflight/checks_test.go
autonomous: true

must_haves:
  truths:
    - "m2cv --version prints version info"
    - "m2cv detects missing claude CLI and prints install instructions before any AI command"
    - "Preflight check for resumed verifies node_modules/resumed or global install"
    - "CLI skeleton uses cobra with PersistentPreRunE for global checks"
  artifacts:
    - path: "cmd/root.go"
      provides: "Root cobra command with PersistentPreRunE preflight"
      exports: ["NewRootCommand", "Execute"]
      min_lines: 30
    - path: "internal/preflight/checks.go"
      provides: "Preflight check functions for external dependencies"
      exports: ["CheckClaude", "CheckResumed", "CheckNPM"]
      min_lines: 30
    - path: "main.go"
      provides: "Entry point calling cmd.Execute()"
      min_lines: 8
  key_links:
    - from: "cmd/root.go"
      to: "internal/preflight/checks.go"
      via: "PersistentPreRunE calls preflight.CheckClaude"
      pattern: "preflight\\.Check"
    - from: "cmd/root.go"
      to: "github.com/spf13/cobra"
      via: "cobra.Command with PersistentPreRunE"
      pattern: "PersistentPreRunE"
    - from: "main.go"
      to: "cmd/root.go"
      via: "cmd.Execute() call"
      pattern: "cmd\\.Execute"
---

<objective>
Wire cobra CLI skeleton with preflight checks that detect missing external dependencies.

Purpose: The CLI skeleton is the user-facing entry point. Preflight checks ensure clear error messages before commands fail with cryptic subprocess errors. This plan connects config, executors, and preflight into a usable CLI.
Output: Working `m2cv` binary with version command and preflight checks for claude/resumed/npm.
</objective>

<execution_context>
@/Users/rich/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rich/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-executors/01-RESEARCH.md
@.planning/phases/01-foundation-and-executors/01-01-SUMMARY.md
@.planning/phases/01-foundation-and-executors/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preflight check functions</name>
  <files>internal/preflight/checks.go, internal/preflight/checks_test.go</files>
  <action>
Create `internal/preflight/checks.go` with:

1. `CheckClaude() error` - uses exec.LookPath("claude") to verify claude CLI is in PATH. On failure, returns error with helpful message:
   ```
   claude CLI not found in PATH

   Install from: https://claude.ai/download
   Requires: Claude Pro subscription

   After installing, verify with: claude --version
   ```

2. `CheckNPM() error` - uses FindNodeExecutable("npm") from internal/executor/find.go. On failure, returns error with helpful message about installing Node.js.

3. `CheckResumed(projectDir string) error` - checks two locations:
   - `filepath.Join(projectDir, "node_modules", "resumed")` via os.Stat
   - `exec.LookPath("resumed")` as global fallback
   On failure, returns error suggesting `m2cv init` or `npm install resumed`.

Create `internal/preflight/checks_test.go`:
- Test CheckResumed finds resumed in node_modules (create temp dir with node_modules/resumed/)
- Test CheckResumed returns error when not found
- Test error messages contain actionable install instructions (check for key substrings)

Note: CheckClaude and CheckNPM depend on system state so test the error message format, not the actual binary presence. Use a helper to test with a modified PATH if needed.
  </action>
  <verify>Run `go test ./internal/preflight/ -v` - all tests pass.</verify>
  <done>Preflight check functions return clear, actionable errors when external dependencies are missing.</done>
</task>

<task type="auto">
  <name>Task 2: Wire cobra CLI with preflight hooks and version command</name>
  <files>cmd/root.go, cmd/version.go, main.go</files>
  <action>
Create `cmd/root.go`:

1. Define package-level version variables (set via ldflags at build time):
   ```go
   var (
       version = "dev"
       commit  = "unknown"
       date    = "unknown"
   )
   ```

2. `NewRootCommand() *cobra.Command` - creates root command:
   - Use: "m2cv"
   - Short: "Markdown to CV - AI-powered resume tailoring"
   - Long: description mentioning pipeline from job description to PDF
   - PersistentPreRunE: Skip preflight for help, version, completion commands. For all other commands, run preflight.CheckClaude(). Note: CheckResumed is command-specific (only for generate), so don't add it here. Just CheckClaude in PersistentPreRunE since ALL functional commands need Claude.
   - Add persistent flag: `--config` (string) for config file path override
   - Add persistent flag: `--base-cv` (string) for base CV path override (WORK-05)

3. `Execute()` function that creates root command, adds subcommands, and calls cmd.Execute().

Create `cmd/version.go`:
- `newVersionCommand() *cobra.Command` with Use: "version"
- Prints version, commit, date
- Add to root command in Execute()

Update `main.go`:
- Import cmd package
- Call `cmd.Execute()`
- Handle error with os.Exit(1)

Important: The PersistentPreRunE should NOT run preflight checks for `version`, `help`, or `completion` subcommands. Check `cmd.Name()` or use `cmd.CalledAs()` to skip preflight for non-functional commands. Pattern:
```go
PersistentPreRunE: func(cmd *cobra.Command, args []string) error {
    // Skip preflight for non-functional commands
    switch cmd.Name() {
    case "version", "help", "completion":
        return nil
    }
    return preflight.CheckClaude()
},
```
  </action>
  <verify>
Run `go build -o m2cv .` - builds successfully.
Run `./m2cv version` - prints version info without preflight errors.
Run `./m2cv --help` - shows help text with available commands and flags.
Run `go test ./cmd/ -v` if any tests exist.
  </verify>
  <done>CLI binary builds and runs. `m2cv version` works without preflight. `m2cv --help` shows flags (--config, --base-cv). Preflight checks run for functional commands.</done>
</task>

</tasks>

<verification>
1. `go build -o m2cv .` - binary builds
2. `./m2cv version` - prints version without errors
3. `./m2cv --help` - shows help with --config and --base-cv flags
4. `go test ./internal/preflight/ -v` - preflight tests pass
5. `go test ./... ` - all project tests pass
</verification>

<success_criteria>
- `m2cv version` prints version info
- `m2cv --help` shows --config and --base-cv persistent flags
- Preflight checks run before functional commands but not version/help
- CheckClaude, CheckNPM, CheckResumed return clear error messages
- All tests pass across entire project
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-executors/01-03-SUMMARY.md`
</output>
