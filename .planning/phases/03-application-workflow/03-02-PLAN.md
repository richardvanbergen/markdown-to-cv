---
phase: 03-application-workflow
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - cmd/apply.go
  - cmd/apply_test.go
  - cmd/root.go
autonomous: true

must_haves:
  truths:
    - "User runs m2cv apply job.txt and application folder is created"
    - "Folder appears under applications/ with AI-extracted name"
    - "Job description file is copied into the application folder"
  artifacts:
    - path: "cmd/apply.go"
      provides: "apply subcommand implementation"
      exports: ["newApplyCommand"]
    - path: "cmd/apply_test.go"
      provides: "Integration tests for apply command"
      min_lines: 50
  key_links:
    - from: "cmd/apply.go"
      to: "internal/extractor/folder_name.go"
      via: "ExtractFolderName call"
      pattern: "extractor\\.ExtractFolderName"
    - from: "cmd/apply.go"
      to: "internal/filesystem/operations.go"
      via: "CreateDir and CopyFile calls"
      pattern: "filesystem\\.(CreateDir|CopyFile)"
    - from: "cmd/root.go"
      to: "cmd/apply.go"
      via: "AddCommand registration"
      pattern: "AddCommand\\(newApplyCommand"
---

<objective>
Implement the apply command that creates job application folders with AI-extracted names.

Purpose: Enable workflow `m2cv apply job-description.txt` that creates organized application folders automatically named from job content.
Output: Working apply subcommand integrated into CLI.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-application-workflow/03-RESEARCH.md

# Prior plan output
@.planning/phases/03-application-workflow/03-01-SUMMARY.md

# Existing CLI structure
@cmd/root.go
@cmd/version.go

# Infrastructure from Phase 1
@internal/executor/claude.go
@internal/config/config.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply Command Implementation</name>
  <files>cmd/apply.go</files>
  <action>
Create cmd/apply.go with apply subcommand following existing cobra patterns in cmd/version.go.

Command structure:
```
m2cv apply <job-description-file>
```

Flags:
- --name, -n: Override folder name (skip Claude extraction)
- --dir, -d: Custom applications directory (default: "applications")

Logic flow:
1. Validate job description file exists (cobra.ExactArgs(1))
2. Read job description content (os.ReadFile)
3. If --name flag not provided:
   - Create ClaudeExecutor (executor.NewClaudeExecutor())
   - Call extractor.ExtractFolderName(ctx, executor, content)
4. If --name flag provided:
   - Use extractor.SanitizeFilename on provided name
5. Build application path: filepath.Join(applicationsDir, folderName)
6. Check if folder already exists -> error with suggestion to use --name
7. Create application folder (filesystem.CreateDir)
8. Copy job description into folder (filesystem.CopyFile)
9. Print success message with folder path

Error handling:
- File not found: "job description file not found: <path>"
- Folder exists: "application folder already exists: <path>. Use --name to specify a different name"
- Claude error: "failed to extract folder name: <error>. Use --name to specify manually"

Function signature: newApplyCommand() *cobra.Command
  </action>
  <verify>go build ./cmd/... - compiles without errors</verify>
  <done>Apply command created with all flags and logic</done>
</task>

<task type="auto">
  <name>Task 2: Wire Apply Command and Add Tests</name>
  <files>cmd/root.go, cmd/apply_test.go</files>
  <action>
1. Update cmd/root.go:
   - Add newApplyCommand() to the AddCommand calls in Execute()
   - Add "apply" to the preflight skip list (apply needs Claude, so don't skip)

2. Create cmd/apply_test.go with integration tests:

Test setup helper:
- Create temp directory structure
- Create mock job description file
- Track created folders for verification

Tests (table-driven where appropriate):

TestApplyCommand_WithNameFlag:
- Setup: Create temp dir with job.txt
- Execute: m2cv apply --name test-company-role --dir tmpdir job.txt
- Verify: applications/test-company-role exists, contains job.txt copy

TestApplyCommand_MissingFile:
- Execute: m2cv apply nonexistent.txt
- Verify: Error contains "not found"

TestApplyCommand_FolderExists:
- Setup: Create applications/existing-folder
- Execute: m2cv apply --name existing-folder job.txt
- Verify: Error contains "already exists"

TestApplyCommand_CustomDir:
- Setup: Create temp dir
- Execute: m2cv apply --name myapp --dir custom-apps job.txt
- Verify: custom-apps/myapp exists

Note: Skip testing actual Claude extraction (requires real Claude) - that's covered by extractor tests with mocks.
Use cobra command.SetArgs() and command.Execute() pattern for testing.
  </action>
  <verify>go test ./cmd/... -v -run TestApply</verify>
  <done>Apply command registered in CLI, tests verify folder creation and error handling</done>
</task>

</tasks>

<verification>
Full integration check:
```bash
go build -o m2cv .
./m2cv apply --help  # Shows usage
go test ./cmd/... -v
```
</verification>

<success_criteria>
- `m2cv apply --help` shows command with flags
- `m2cv apply --name test-job job.txt` creates applications/test-job with copied file
- Folder collision returns helpful error
- Missing file returns helpful error
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-application-workflow/03-02-SUMMARY.md`
</output>
