---
phase: 05-export-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - cmd/generate.go
  - cmd/generate_test.go
  - cmd/root.go
autonomous: true

must_haves:
  truths:
    - "User runs m2cv generate <app-name> and gets PDF output"
    - "Theme can be overridden with --theme flag"
    - "Model can be overridden with -m flag"
    - "Command fails gracefully with clear error if no optimized CV exists"
  artifacts:
    - path: "cmd/generate.go"
      provides: "generate subcommand implementation"
      exports: ["newGenerateCommand"]
    - path: "cmd/generate_test.go"
      provides: "command tests with mock executor"
      min_lines: 50
  key_links:
    - from: "cmd/generate.go"
      to: "internal/generator/extractor.go"
      via: "generator.ExtractJSON call"
      pattern: "generator\\.ExtractJSON"
    - from: "cmd/generate.go"
      to: "internal/generator/validator.go"
      via: "validator.Validate call"
      pattern: "validator\\.Validate"
    - from: "cmd/generate.go"
      to: "internal/generator/exporter.go"
      via: "exporter.ExportPDF call"
      pattern: "exporter\\.ExportPDF"
    - from: "cmd/root.go"
      to: "cmd/generate.go"
      via: "AddCommand(newGenerateCommand())"
      pattern: "newGenerateCommand"
---

<objective>
Implement the generate command that orchestrates the full pipeline: read optimized CV, convert to JSON Resume via Claude, validate against schema, export PDF via resumed.

Purpose: This is the user-facing command that completes the m2cv workflow. Users can now go from job description to PDF resume with `m2cv apply`, `m2cv optimize`, and `m2cv generate`.

Output: Working generate command with --theme and -m flags, wired to root, with tests covering the orchestration flow.
</objective>

<execution_context>
@/home/claude/.claude/get-shit-done/workflows/execute-plan.md
@/home/claude/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-export-pipeline/05-RESEARCH.md
@.planning/phases/05-export-pipeline/05-01-SUMMARY.md

# Command patterns to follow
@cmd/optimize.go (command structure, flag handling, config loading)
@cmd/apply.go (application folder handling)

# Generator components (from Plan 01)
@internal/generator/extractor.go
@internal/generator/validator.go
@internal/generator/exporter.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Command Implementation</name>
  <files>cmd/generate.go</files>
  <action>
Create cmd/generate.go following optimize.go pattern with:

newGenerateCommand() *cobra.Command:
- Use: "generate <application-name>"
- Short: "Generate PDF resume from optimized CV"
- Args: cobra.ExactArgs(1)
- Flags: --theme (string), -m/--model (string)
- PreRunE: preflight.CheckResumed(projectDir) - command-specific check

runGenerate(ctx, appName, themeFlag, modelFlag string) error:

1. Validate application folder exists (applications/{appName})
2. Load config via config.FindWithOverrides(cfgFile, ".")
3. Determine theme: flag > config.DefaultTheme
4. Determine model: flag > config.DefaultModel
5. Find latest optimized CV via application.LatestVersionPath(appDir)
   - Error if empty: "no optimized CV found. Run 'm2cv optimize' first"
6. Read CV content
7. Load md-to-json-resume prompt via assets.GetPrompt
8. Substitute {{.CV}} with content
9. Execute Claude via executor.NewClaudeExecutor with model option
10. Extract JSON via generator.ExtractJSON
11. Validate via generator.NewValidator().Validate
12. Write resume.json to appDir (for debugging)
13. Export PDF via generator.NewExporter().ExportPDF
    - jsonPath: appDir/resume.json
    - outputPath: appDir/resume.pdf
    - theme: determined above
    - projectDir: filepath.Dir(configPath)
14. Print success: "PDF written to: {path}"

Error messages should be actionable (include commands to run).
  </action>
  <verify>go build -o /tmp/m2cv ./cmd/... && /tmp/m2cv generate --help</verify>
  <done>generate command compiles and shows help with --theme and -m flags</done>
</task>

<task type="auto">
  <name>Task 2: Wire Generate to Root and Test</name>
  <files>cmd/root.go, cmd/generate_test.go</files>
  <action>
In cmd/root.go, add to init():
- rootCmd.AddCommand(newGenerateCommand())

Create cmd/generate_test.go with tests following optimize_test.go pattern:

Test structure:
- Use t.TempDir() for isolated test environment
- Create mock config file (m2cv.yml)
- Create mock application folder with optimized CV
- Disable preflight checks via rootCmd.PersistentPreRunE = nil

Test cases:

1. TestGenerateCommand_MissingApplication
   - No application folder exists
   - Expect error containing "not found"

2. TestGenerateCommand_NoOptimizedCV
   - Application folder exists but no optimized-cv-*.md
   - Expect error containing "no optimized CV" or "optimize"

3. TestGenerateCommand_ConfigResolution
   - Verify config is loaded and theme/model resolved
   - Mock Claude executor would be needed for full test
   - Note: Full integration test requires resumed, may need skip

4. TestGenerateCommand_FlagOverrides
   - Create test with --theme and -m flags
   - Verify flags parsed correctly (can test command setup)

Pattern from optimize_test.go:
- Create minimal test config
- Create application folder structure
- Test error paths without needing Claude/resumed

Note: Full E2E test requires Claude CLI + npm + resumed. Use t.Skip() pattern from existing tests when dependencies unavailable.
  </action>
  <verify>go test -v ./cmd/... -run TestGenerate</verify>
  <done>generate command wired to root, tests cover error paths and flag parsing</done>
</task>

</tasks>

<verification>
Full command works end-to-end:

```bash
# Build and verify help
go build -o /tmp/m2cv ./cmd/...
/tmp/m2cv generate --help

# Run tests
go test -v ./cmd/... -run TestGenerate

# Verify no vet errors
go vet ./cmd/...
```
</verification>

<success_criteria>
1. m2cv generate <app-name> executes full pipeline
2. --theme flag overrides config.DefaultTheme
3. -m flag overrides config.DefaultModel
4. Clear error messages for: missing app, no optimized CV, Claude failure, validation failure, export failure
5. resume.json written to application folder for debugging
6. resume.pdf written to application folder as final output
7. Tests pass with appropriate skips for missing dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/05-export-pipeline/05-02-SUMMARY.md`
</output>
